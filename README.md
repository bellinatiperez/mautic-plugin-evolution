# MauticEvolutionBundle

Plugin oficial para integra√ß√£o entre Mautic e Evolution API, permitindo o envio de mensagens WhatsApp atrav√©s de campanhas automatizadas.

## üìã √çndice

1. [Estado Atual do Plugin](#estado-atual-do-plugin)
2. [Requisitos do Sistema](#requisitos-do-sistema)
3. [Instala√ß√£o e Configura√ß√£o](#instala√ß√£o-e-configura√ß√£o)
4. [Exemplos Pr√°ticos de Utiliza√ß√£o](#exemplos-pr√°ticos-de-utiliza√ß√£o)
5. [Funcionalidades Implementadas](#funcionalidades-implementadas)
6. [Configura√ß√µes Avan√ßadas](#configura√ß√µes-avan√ßadas)
7. [Solu√ß√£o de Problemas](#solu√ß√£o-de-problemas)
8. [Estrutura do Plugin](#estrutura-do-plugin)
9. [Contribui√ß√£o](#contribui√ß√£o)

## üöÄ Estado Atual do Plugin

### Vers√£o Atual
- **Vers√£o**: 1.0.0
- **Status**: Est√°vel
- **√öltima Atualiza√ß√£o**: 2024

### Compatibilidade
- **Mautic**: >= 6.0
- **PHP**: >= 8.1
- **Evolution API**: >= 1.5.0
- **Symfony**: >= 6.0

### Funcionalidades Implementadas ‚úÖ

- ‚úÖ **Envio de Mensagens de Texto**: Mensagens simples via WhatsApp
- ‚úÖ **Envio de M√≠dia**: Imagens, documentos e outros arquivos
- ‚úÖ **Templates Din√¢micos**: Sistema completo de templates com vari√°veis
- ‚úÖ **Integra√ß√£o com Campanhas**: Actions nativas no Campaign Builder
- ‚úÖ **Webhooks**: Recebimento de status de entrega e leitura
- ‚úÖ **Sistema de Logs**: Auditoria completa de mensagens enviadas
- ‚úÖ **Interface Administrativa**: Gerenciamento via painel do Mautic
- ‚úÖ **Processamento de Status**: Atualiza√ß√£o autom√°tica de status de mensagens

### Funcionalidades em Desenvolvimento üöß

- üöß **Mensagens de √Åudio**: Envio de mensagens de voz
- üöß **Bot√µes Interativos**: Suporte a bot√µes e menus
- üöß **Relat√≥rios Avan√ßados**: Dashboard com m√©tricas detalhadas

## üîß Requisitos do Sistema

### Requisitos Obrigat√≥rios

#### Servidor
- **PHP**: 8.1 ou superior
- **Composer**: Para gerenciamento de depend√™ncias
- **Extens√µes PHP**:
  - `curl`
  - `json`
  - `mbstring`
  - `openssl`

#### Mautic
- **Vers√£o**: 6.0 ou superior
- **Permiss√µes**: Acesso de administrador para configura√ß√£o
- **Banco de Dados**: MySQL/MariaDB com suporte a UTF8MB4

#### Evolution API
- **Vers√£o**: 1.5.0 ou superior
- **Inst√¢ncia WhatsApp**: Configurada e conectada
- **API Key**: V√°lida e ativa
- **Webhook Endpoint**: Acess√≠vel publicamente

### Depend√™ncias PHP

```json
{
    "php": ">=8.1",
    "guzzlehttp/guzzle": "^7.0",
    "symfony/http-foundation": "^6.0",
    "doctrine/orm": "^2.14"
}
```

## üì¶ Instala√ß√£o e Configura√ß√£o

### Passo 1: Instala√ß√£o do Plugin

#### Op√ß√£o A: Via Composer (Recomendado)
```bash
cd /caminho/para/mautic
composer require mautic/evolution-bundle
```

#### Op√ß√£o B: Instala√ß√£o Manual
```bash
# Clone o reposit√≥rio na pasta de plugins
cd plugins/
git clone https://github.com/mautic/MauticEvolutionBundle.git
```

### Passo 2: Ativa√ß√£o no Mautic

```bash
# Limpar cache do Mautic
php bin/console cache:clear

# Instalar assets do plugin
php bin/console mautic:assets:generate

# Atualizar schema do banco de dados
php bin/console doctrine:schema:update --force
```

### Passo 3: Configura√ß√£o da Integra√ß√£o

1. **Acesse o Painel Administrativo**:
   - V√° para `Configura√ß√µes` ‚Üí `Plugins`
   - Encontre "Mautic Evolution Plugin"
   - Clique em "Configurar"

2. **Configure os Par√¢metros B√°sicos**:

| Campo | Descri√ß√£o | Obrigat√≥rio |
|-------|-----------|-------------|
| **URL da Evolution API** | URL base da sua inst√¢ncia Evolution API | ‚úÖ |
| **API Key** | Chave de autentica√ß√£o da Evolution API | ‚úÖ |
| **Timeout** | Tempo limite para requisi√ß√µes (segundos) | ‚ùå |
| **Habilitar Webhooks** | Receber atualiza√ß√µes de status | ‚ùå |
| **Modo Debug** | Logs detalhados para desenvolvimento | ‚ùå |

3. **Exemplo de Configura√ß√£o**:
```php
// Configura√ß√£o via interface ou arquivo local.php
$config = [
    'evolution_api_url' => 'https://sua-evolution-api.com',
    'evolution_api_key' => 'sua-api-key-aqui',
    'evolution_timeout' => 30,
    'evolution_webhook_enabled' => true,
    'evolution_debug_mode' => false
];
```

### Passo 4: Configura√ß√£o de Webhooks

1. **Configure o Webhook na Evolution API**:
```bash
curl -X POST "https://sua-evolution-api.com/external-webhook/create" \
  -H "Content-Type: application/json" \
  -H "apikey: sua-api-key" \
  -d '{
    "name": "Update event send",
    "url": "http://seu.mautic/webhook/evolution/receive",
    "enabled": true,
    "events": ["messages.update"],
    "description": "Webhook para testar evento MESSAGES_UPDATE"
  }'
```

2. **Teste a Conectividade**:
```bash
# Verificar health check
curl https://seu-mautic.com/webhook/evolution/health

# Resposta esperada:
# {"status": "ok", "timestamp": "2024-01-01T12:00:00Z"}
```

## üí° Exemplos Pr√°ticos de Utiliza√ß√£o

### 1. Envio de Mensagem Simples em Campanha

1. **Criar Nova Campanha**:
   - V√° para `Campanhas` ‚Üí `Nova Campanha`
   - Configure os crit√©rios de entrada

2. **Adicionar Action Evolution**:
   - No Campaign Builder, clique em "+"
   - Selecione "Actions" ‚Üí "Enviar Mensagem WhatsApp"
   - Configure a mensagem:

```
Ol√° {contactfield=firstname}!

Temos uma oferta especial para voc√™:
üéØ {contactfield=custom_offer}

V√°lida at√©: {contactfield=offer_expiry}

Responda QUERO para mais informa√ß√µes!
```

### 2. Envio de Template Personalizado

1. **Criar Template**:
   - V√° para `Evolution` ‚Üí `Templates`
   - Clique em "Novo Template"

2. **Configurar Template**:
```json
{
  "name": "Boas-vindas",
  "content": "Bem-vindo(a) {contactfield=firstname}!\n\nSua conta foi criada com sucesso.\nID: {contactfield=id}\nE-mail: {contactfield=email}",
  "variables": ["firstname", "id", "email"]
}
```

3. **Usar em Campanha**:
   - Action: "Enviar Template WhatsApp"
   - Selecionar template criado
   - Configurar campo do telefone (padr√£o: `mobile`)

### 3. Envio de M√≠dia com Caption

```php
// Exemplo via API Service
$evolutionApi = $this->get('mautic.evolution.api.service');

$result = $evolutionApi->sendMediaMessage(
    '+5511999999999',
    'https://exemplo.com/imagem.jpg',
    'Confira nossa nova promo√ß√£o! üéâ',
    $contact,
    $event
);
```

### 4. Configura√ß√£o de Webhook Personalizado

```php
// No seu EventListener personalizado
public function onWebhookReceived(WebhookEvent $event): void
{
    $data = $event->getData();
    
    if ($data['event'] === 'MESSAGES_UPDATE') {
        $messageId = $data['data']['key']['id'];
        $status = $data['data']['status'];
        
        // Processar atualiza√ß√£o de status
        $this->updateMessageStatus($messageId, $status);
    }
}
```

## üîß Funcionalidades Implementadas

### Sistema de Mensagens

#### Tipos de Mensagem Suportados
- **Texto Simples**: Mensagens de texto com suporte a emojis
- **M√≠dia**: Imagens, documentos, √°udios e v√≠deos
- **Templates**: Mensagens padronizadas com vari√°veis din√¢micas

#### Vari√°veis Dispon√≠veis
Todas as vari√°veis de contato do Mautic podem ser utilizadas:
- `{contactfield=firstname}` - Nome
- `{contactfield=lastname}` - Sobrenome
- `{contactfield=email}` - E-mail
- `{contactfield=mobile}` - Telefone
- `{contactfield=company}` - Empresa
- Campos personalizados: `{contactfield=nome_do_campo}`

### Sistema de Templates

#### Gerenciamento de Templates
- **CRUD Completo**: Criar, editar, visualizar e excluir templates
- **Preview**: Visualiza√ß√£o pr√©via com dados de exemplo
- **Clonagem**: Duplicar templates existentes
- **Ativa√ß√£o/Desativa√ß√£o**: Controle de status dos templates

#### Estrutura de Template
```json
{
  "id": 1,
  "name": "Nome do Template",
  "content": "Conte√∫do com {contactfield=variavel}",
  "isPublished": true,
  "dateAdded": "2024-01-01T12:00:00Z",
  "dateModified": "2024-01-01T12:00:00Z"
}
```

### Sistema de Webhooks

#### Eventos Suportados
- `MESSAGES_UPSERT`: Nova mensagem recebida
- `MESSAGES_UPDATE`: Atualiza√ß√£o de status de mensagem
- `SEND_MESSAGE`: Confirma√ß√£o de envio

#### Status de Mensagem
- `PENDING`: Aguardando envio
- `SENT`: Enviada
- `DELIVERY_ACK`: Entregue
- `READ`: Lida
- `FAILED`: Falha no envio

### Integra√ß√£o com Campanhas

#### Actions Dispon√≠veis
1. **Enviar Mensagem WhatsApp**
   - Mensagem de texto personalizada
   - Suporte a vari√°veis de contato
   - Configura√ß√£o de campo de telefone

2. **Enviar Template WhatsApp**
   - Sele√ß√£o de template pr√©-configurado
   - Substitui√ß√£o autom√°tica de vari√°veis
   - Valida√ß√£o de campos obrigat√≥rios

#### Configura√ß√µes de Action
```php
// Configura√ß√£o de envio de mensagem
[
    'message' => 'Sua mensagem aqui com {contactfield=firstname}',
    'phone_field' => 'mobile', // Campo que cont√©m o telefone
    'media_url' => '', // URL da m√≠dia (opcional)
    'media_caption' => '' // Legenda da m√≠dia (opcional)
]
```

## ‚öôÔ∏è Configura√ß√µes Avan√ßadas

### Configura√ß√£o de Timeout
```php
// config/local.php
return [
    'parameters' => [
        'evolution_timeout' => 60, // 60 segundos
        'evolution_retry_attempts' => 3,
        'evolution_retry_delay' => 5 // 5 segundos entre tentativas
    ]
];
```

### Configura√ß√£o de Logs
```php
// Habilitar logs detalhados
'evolution_debug_mode' => true,
'evolution_log_level' => 'debug', // debug, info, warning, error
'evolution_log_file' => 'var/logs/evolution.log'
```

### Configura√ß√£o de Webhook Personalizado
```php
// EventListener personalizado
class CustomWebhookListener implements EventSubscriberInterface
{
    public static function getSubscribedEvents(): array
    {
        return [
            'mautic.evolution.webhook.received' => 'onWebhookReceived'
        ];
    }
    
    public function onWebhookReceived(WebhookEvent $event): void
    {
        // Sua l√≥gica personalizada aqui
    }
}
```

## üîç Solu√ß√£o de Problemas

### Problemas Comuns

#### 1. Erro de Conex√£o com Evolution API
**Sintoma**: `Connection timeout` ou `Connection refused`

**Solu√ß√µes**:
```bash
# Verificar conectividade
curl -I https://sua-evolution-api.com

# Testar API Key
curl -H "apikey: sua-key" https://sua-evolution-api.com/instance/connectionState/sua-instancia

# Verificar logs do Mautic
tail -f var/logs/mautic_prod.log | grep evolution
```

#### 2. Mensagens N√£o Enviadas
**Sintoma**: Status permanece como `PENDING`

**Verifica√ß√µes**:
1. **Inst√¢ncia WhatsApp Conectada**:
```bash
curl -H "apikey: sua-key" \
  https://sua-evolution-api.com/instance/connectionState/sua-instancia
```

2. **Formato do N√∫mero**:
```php
// Formato correto: +5511999999999
// Formato incorreto: 11999999999, (11) 99999-9999
```

3. **Logs de Erro**:
```bash
# Verificar logs espec√≠ficos do Evolution
grep -i "evolution" var/logs/mautic_prod.log

# Verificar logs de campanha
grep -i "campaign" var/logs/mautic_prod.log
```

#### 3. Webhooks N√£o Funcionando
**Sintoma**: Status de mensagens n√£o atualizam

**Verifica√ß√µes**:
1. **URL do Webhook Acess√≠vel**:
```bash
curl -X POST https://seu-mautic.com/webhook/evolution/receive \
  -H "Content-Type: application/json" \
  -d '{"test": true}'
```

2. **Configura√ß√£o na Evolution API**:
```bash
curl -H "apikey: sua-key" \
  https://sua-evolution-api.com/webhook/find/sua-instancia
```

3. **Logs de Webhook**:
```bash
tail -f var/logs/mautic_prod.log | grep webhook
```

#### 4. Erro de Banco de Dados
**Sintoma**: `Table 'evolution_messages' doesn't exist`

**Solu√ß√£o**:
```bash
# Atualizar schema do banco
php bin/console doctrine:schema:update --force

# Verificar se as tabelas foram criadas
php bin/console doctrine:schema:validate
```

#### 5. Problemas de Permiss√£o
**Sintoma**: `Access denied` ou `Permission denied`

**Verifica√ß√µes**:
1. **Permiss√µes de Arquivo**:
```bash
# Definir permiss√µes corretas
chmod -R 755 plugins/MauticEvolutionBundle/
chown -R www-data:www-data plugins/MauticEvolutionBundle/
```

2. **Permiss√µes do Usu√°rio no Mautic**:
   - Verificar se o usu√°rio tem permiss√£o para gerenciar plugins
   - Verificar permiss√µes de campanha

### Comandos de Diagn√≥stico

#### Verificar Status do Plugin
```bash
# Listar plugins instalados
php bin/console mautic:plugins:list

# Verificar status espec√≠fico
php bin/console mautic:plugins:install --plugin=MauticEvolutionBundle
```

#### Testar Conectividade
```bash
# Script de teste de conectividade
php bin/console mautic:evolution:test-connection
```

#### Limpar Cache
```bash
# Limpar todos os caches
php bin/console cache:clear

# Limpar cache espec√≠fico do plugin
php bin/console cache:clear --env=prod
```

### Logs Importantes

#### Localiza√ß√£o dos Logs
- **Logs Gerais**: `var/logs/mautic_prod.log`
- **Logs de Desenvolvimento**: `var/logs/mautic_dev.log`
- **Logs de Campanha**: Filtrar por `campaign` nos logs gerais

#### Exemplos de Logs

**Envio Bem-sucedido**:
```
[2024-01-01 12:00:00] mautic.INFO: Evolution message sent successfully 
{"messageId": "ABC123", "contact": 123, "phone": "+5511999999999"}
```

**Erro de Envio**:
```
[2024-01-01 12:00:00] mautic.ERROR: Evolution API error 
{"error": "Instance not connected", "phone": "+5511999999999"}
```

**Webhook Recebido**:
```
[2024-01-01 12:00:00] mautic.INFO: Evolution webhook received 
{"event": "MESSAGES_UPDATE", "messageId": "ABC123", "status": "READ"}
```

## üìÅ Estrutura do Plugin

```
MauticEvolutionBundle/
‚îú‚îÄ‚îÄ Assets/                     # Recursos est√°ticos
‚îÇ   ‚îú‚îÄ‚îÄ css/evolution.css      # Estilos do plugin
‚îÇ   ‚îú‚îÄ‚îÄ js/evolution.js        # Scripts JavaScript
‚îÇ   ‚îî‚îÄ‚îÄ images/                # Imagens e √≠cones
‚îú‚îÄ‚îÄ Config/                     # Configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ config.php             # Configura√ß√£o principal
‚îÇ   ‚îî‚îÄ‚îÄ services.php           # Defini√ß√£o de servi√ßos
‚îú‚îÄ‚îÄ Controller/                 # Controladores
‚îÇ   ‚îú‚îÄ‚îÄ TemplateController.php # Gerenciamento de templates
‚îÇ   ‚îî‚îÄ‚îÄ WebhookController.php  # Recebimento de webhooks
‚îú‚îÄ‚îÄ Entity/                     # Entidades do banco
‚îÇ   ‚îú‚îÄ‚îÄ EvolutionMessage.php   # Entidade de mensagens
‚îÇ   ‚îú‚îÄ‚îÄ EvolutionMessageRepository.php
‚îÇ   ‚îú‚îÄ‚îÄ EvolutionTemplate.php  # Entidade de templates
‚îÇ   ‚îî‚îÄ‚îÄ EvolutionTemplateRepository.php
‚îú‚îÄ‚îÄ EventListener/              # Event Listeners
‚îÇ   ‚îú‚îÄ‚îÄ CampaignSubscriber.php # Integra√ß√£o com campanhas
‚îÇ   ‚îú‚îÄ‚îÄ LeadSubscriber.php     # Eventos de contatos
‚îÇ   ‚îî‚îÄ‚îÄ PluginSubscriber.php   # Eventos do plugin
‚îú‚îÄ‚îÄ Form/                       # Formul√°rios
‚îÇ   ‚îî‚îÄ‚îÄ Type/                  # Tipos de formul√°rio
‚îÇ       ‚îú‚îÄ‚îÄ EvolutionConfigType.php
‚îÇ       ‚îú‚îÄ‚îÄ SendMessageActionType.php
‚îÇ       ‚îî‚îÄ‚îÄ SendTemplateActionType.php
‚îú‚îÄ‚îÄ Integration/                # Integra√ß√£o principal
‚îÇ   ‚îî‚îÄ‚îÄ MauticEvolutionIntegration.php
‚îú‚îÄ‚îÄ Model/                      # Modelos de neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ MessageModel.php       # Modelo de mensagens
‚îÇ   ‚îî‚îÄ‚îÄ TemplateModel.php      # Modelo de templates
‚îú‚îÄ‚îÄ Service/                    # Servi√ßos
‚îÇ   ‚îú‚îÄ‚îÄ EvolutionApiService.php # Comunica√ß√£o com API
‚îÇ   ‚îú‚îÄ‚îÄ MessageService.php     # Processamento de mensagens
‚îÇ   ‚îî‚îÄ‚îÄ WebhookService.php     # Processamento de webhooks
‚îú‚îÄ‚îÄ Resources/                  # Recursos de visualiza√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ translations/          # Tradu√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ views/                 # Templates Twig
‚îú‚îÄ‚îÄ composer.json              # Depend√™ncias
‚îú‚îÄ‚îÄ MauticEvolutionBundle.php  # Classe principal
‚îî‚îÄ‚îÄ README.md                  # Esta documenta√ß√£o
```

## ü§ù Contribui√ß√£o

### Como Contribuir

1. **Fork do Reposit√≥rio**
2. **Criar Branch de Feature**:
```bash
git checkout -b feature/nova-funcionalidade
```

3. **Implementar Mudan√ßas**
4. **Executar Testes**:
```bash
php bin/console mautic:test:evolution
```

5. **Commit e Push**:
```bash
git commit -m "feat: adiciona nova funcionalidade"
git push origin feature/nova-funcionalidade
```

6. **Criar Pull Request**

### Padr√µes de C√≥digo

- **PSR-12**: Padr√£o de codifica√ß√£o PHP
- **Symfony Best Practices**: Conven√ß√µes do Symfony
- **Mautic Coding Standards**: Padr√µes espec√≠ficos do Mautic

### Testes

```bash
# Executar todos os testes
php bin/console test

# Testes espec√≠ficos do plugin
php bin/console test plugins/MauticEvolutionBundle/Tests/
```

---

## üìû Suporte

- **Documenta√ß√£o**: [Wiki do Projeto](https://github.com/mautic/MauticEvolutionBundle/wiki)
- **Issues**: [GitHub Issues](https://github.com/mautic/MauticEvolutionBundle/issues)
- **Discuss√µes**: [GitHub Discussions](https://github.com/mautic/MauticEvolutionBundle/discussions)
- **E-mail**: support@mautic.org

---

**Desenvolvido com ‚ù§Ô∏è pela equipe Solu√ß√µes Digitais